//1ã€å¤©ä¹¦ç‰ˆ11.0é‡æ„ç‰ˆå¸¦æ§æµæ¨¡å¼ï¼Œåœ¨10çš„åŸºç¡€ä¸Šåšäº†ä¸€äº›ç®€åŒ–æ•´åˆè€Œå·²ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ï¼Œç»™å¤§å®¶å¤šä¸€ä¸ªé€‰æ‹©ï¼Œå»ºè®®pageséƒ¨ç½²
//2ã€æ”¯æŒåä»£å¼€å…³ï¼Œç§é’¥å¼€å…³ï¼Œè®¢é˜…éšè—å¼€å…³åŠŸèƒ½ï¼Œclashç§é’¥é˜²æ­¢è¢«è–…è¯·æ±‚æ•°
//4ã€æ”¯æŒSOCKS5ï¼Œæ”¯æŒS5å…¨å±€åä»£ï¼ŒSOCKS5å’ŒåŸå§‹åä»£åªèƒ½äºŒé€‰ä¸€ï¼ŒSOCKS5æ¡æ‰‹è¿‡ç¨‹è¾ƒä¸ºç¹æ‚ï¼Œå»ºè®®æœ‰é«˜é€Ÿç¨³å®šSOCKS5çš„äººä½¿ç”¨
//5ã€å¯èƒ½æ”¯æŒçš„ç¯å¢ƒå˜é‡åã€SOCKS5ã€‘è´¦å·ï¼Œã€SOCKS5OPENã€‘å¼€å…³S5åä»£trueæˆ–falseï¼Œã€SOCKS5GLOBALã€‘å…¨å±€S5åä»£è½åœ°trueæˆ–falseï¼Œã€PROXYIPã€‘åä»£IPï¼Œåˆ°ç›¸å…³ä»£ç æ®µè½çœ‹çœ‹å…ˆã€100è¡Œå·¦å³ã€‘ï¼ï¼ï¼
//6ã€ä¸ç”¨åœ¨æ„è„šæœ¬å†…é‚£äº›å¥‡æ€ªçš„å˜é‡åï¼Œæ ¹æ®åé¢æ³¨é‡Šçš„å¤‡æ³¨å»æ”¹ï¼Œå¤§æ¦‚ä¹Ÿå°±é…ç½®åŒºå—çœ‹ä¸€ä¸‹å¤‡æ³¨å°±è¡Œï¼Œclashé…ç½®åœ¨åº•éƒ¨ï¼Œæ‡‚çš„å¯ä»¥æ ¹æ®è‡ªèº«éœ€æ±‚ä¿®æ”¹
//7ã€çº¯æ‰‹æ“é…ç½®ï¼Œå»é™¤ä»»ä½•APIå¤–é“¾ï¼Œç›´æ¥æ”¹å¥½äº†éƒ¨ç½²å°±è¡Œï¼Œè¿™æ ·å®‰å…¨æ€§å²æ— å‰ä¾‹
//8ã€é€šç”¨è®¢é˜…ä¸æ”¯æŒç§é’¥åŠŸèƒ½ï¼Œä½¿ç”¨é€šç”¨è®¢é˜…éœ€å…³é—­ç§é’¥åŠŸèƒ½å†è®¢é˜…èŠ‚ç‚¹ï¼ŒCFä¸æ”¯æŒè‡ªèº«1.1.1.1çš„DNSè§£æï¼Œå¦‚æœæ— æ³•è¿é€šå¯ä»¥æ£€æŸ¥å®¢æˆ·ç«¯DNSè®¾ç½®
//9ã€ç”±äºæœ¬äººä»…ä½¿ç”¨openclashå’Œclash metaï¼Œå…¶ä»–å¹³å°è½¯ä»¶å‡æœªæµ‹è¯•ï¼Œè¯·è‡ªè¡Œæµ‹è¯•ç ”ç©¶ï¼Œè¦æ˜¯ä¸èƒ½ç”¨å°±ç®—äº†ï¼Œä¸è´Ÿè´£æ”¹è¿›ï¼Œç»§ç»­æ¦‚ä¸è´Ÿè´£^_^
//10ã€ç”±äºæœ¬äººçº¯èœï¼Œå¾ˆå¤šä»£ç è§£é‡Šéƒ½æ˜¯æ ¹æ®è‡ªå·±çš„ç†è§£çç¼–çš„ï¼Œä¸“ä¸šçš„æ— è§†å°±å¥½ï¼Œå•çº¯ä¸ºäº†å¸®åŠ©å°ç™½ç†è§£ä»£ç å¤§è‡´åŸç†^_^
//11ã€é‡è¦ï¼ï¼ï¼è¯·å¤§å®¶ä¸è¦å‘å¤§ç¾¤ï¼Œè¦æ˜¯å› ä¸ºä¼ æ’­å¹¿æ³›è¢«å°äº†æœ¬äººæŠ€æœ¯æœ‰é™æ²¡æœ‰èƒ½åŠ›è¿›è¡Œä¿®å¤
import { connect } from 'cloudflare:sockets';
//////////////////////////////////////////////////////////////////////////é…ç½®åŒºå—////////////////////////////////////////////////////////////////////////
let å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š = "511622"; //å®é™…ä¸Šè¿™æ˜¯ä½ çš„è®¢é˜…è·¯å¾„ï¼Œæ”¯æŒä»»æ„å¤§å°å†™å­—æ¯å’Œæ•°å­—ï¼Œ[åŸŸå/ID]è¿›å…¥è®¢é˜…é¡µé¢
let å“å‘€å‘€è¿™æ˜¯æˆ‘çš„VLå¯†é’¥ = "aa6afb24-210c-4fdc-979e-58f71a6f779f"; //è¿™æ˜¯çœŸå®çš„UUIDï¼Œé€šç”¨è®¢é˜…ä¼šè¿›è¡ŒéªŒè¯ï¼Œå»ºè®®ä¿®æ”¹ä¸ºè‡ªå·±çš„è§„èŒƒåŒ–UUID

let ç§é’¥å¼€å…³ = false //æ˜¯å¦å¯ç”¨ç§é’¥åŠŸèƒ½ï¼Œtrueå¯ç”¨ï¼Œfalseä¸å¯ç”¨ï¼Œå› ä¸ºç§é’¥åŠŸèƒ½åªæ”¯æŒclashï¼Œå¦‚æœæ‰“ç®—ä½¿ç”¨é€šç”¨è®¢é˜…åˆ™éœ€å…³é—­ç§é’¥åŠŸèƒ½
let å’¦è¿™æ˜¯æˆ‘çš„ç§é’¥å“ = ""; //è¿™æ˜¯ä½ çš„ç§é’¥ï¼Œæé«˜éšç§˜æ€§å®‰å…¨æ€§ï¼Œå°±ç®—åˆ«äººæ‰«åˆ°ä½ çš„åŸŸåä¹Ÿæ— æ³•é“¾æ¥ï¼Œå†ä¹Ÿä¸æ€•åˆ«äººè–…è¯·æ±‚æ•°äº†^_^

let éšè—è®¢é˜… = false //é€‰æ‹©æ˜¯å¦éšè—è®¢é˜…é¡µé¢ï¼Œfalseä¸éšè—ï¼Œtrueéšè—ï¼Œå½“ç„¶éšè—åè‡ªå·±ä¹Ÿæ— æ³•è®¢é˜…ï¼Œå› ä¸ºé…ç½®å›ºå®šï¼Œé€‚åˆè‡ªå·±è®¢é˜…åå°±éšè—ï¼Œé˜²æ­¢è¢«çˆ¬è®¢é˜…ï¼Œå¹¶ä¸”å¯ä»¥åˆ°ä¸‹æ–¹æ·»åŠ å˜²è®½è¯­^_^
let å˜²è®½è¯­ = "å“å‘€ä½ æ‰¾åˆ°äº†æˆ‘ï¼Œä½†æ˜¯æˆ‘å°±æ˜¯ä¸ç»™ä½ çœ‹ï¼Œæ°”ä¸æ°”ï¼Œå˜¿å˜¿å˜¿" //éšè—è®¢é˜…åï¼ŒçœŸå®çš„è®¢é˜…é¡µé¢å°±ä¼šæ˜¾ç¤ºè¿™æ®µè¯ï¼Œæƒ³å†™å•¥å†™å•¥

let æˆ‘çš„ä¼˜é€‰ = ['laji.jisucf.cloudns.biz'] //æ ¼å¼127.0.0.1:443#US@notlsæˆ–[2606:4700:3030:0:4563:5696:a36f:cdc5]:2096#USï¼Œå¦‚æœ#USä¸å¡«åˆ™ä½¿ç”¨ç»Ÿä¸€åç§°ï¼Œå¦‚æœ@notlsä¸å¡«åˆ™é»˜è®¤ä½¿ç”¨TLSï¼Œæ¯è¡Œä¸€ä¸ªï¼Œå¦‚æœä¸å¡«ä»»ä½•èŠ‚ç‚¹ä¼šç”Ÿæˆä¸€ä¸ªé»˜è®¤è‡ªèº«åŸŸåçš„å°é»„äº‘èŠ‚ç‚¹
let æˆ‘çš„ä¼˜é€‰TXT =[ //æ”¯æŒå¤šTXTé“¾æ¥ï¼Œå¯ä»¥æ±‡èšå„è·¯å¤§ç¥çš„èŠ‚ç‚¹ã€æ ¼å¼ç›¸åŒçš„æƒ…å†µä¸‹ã€‘ï¼Œæ–¹ä¾¿èŠ‚ç‚¹ææ…Œç—‡åŒå­¦
  '',
] //ä¼˜é€‰TXTè·¯å¾„[https://ip.txt]ï¼Œè¡¨è¾¾æ ¼å¼ä¸ä¸Šè¿°ç›¸åŒï¼Œä½¿ç”¨TXTæ—¶è„šæœ¬å†…éƒ¨å¡«å†™çš„èŠ‚ç‚¹æ— æ•ˆï¼ŒäºŒé€‰ä¸€

let å¯ç”¨åä»£åŠŸèƒ½ = true //é€‰æ‹©æ˜¯å¦å¯ç”¨åä»£åŠŸèƒ½ã€æ€»å¼€å…³ã€‘ï¼Œfalseï¼Œtrueï¼Œç°åœ¨ä½ å¯ä»¥è‡ªç”±çš„é€‰æ‹©æ˜¯å¦å¯ç”¨åä»£åŠŸèƒ½äº†
let åä»£IP = 'git.jisucf.cloudns.ch' //åä»£IPæˆ–åŸŸåï¼Œåä»£IPç«¯å£ä¸€èˆ¬æƒ…å†µä¸‹ä¸ç”¨å¡«å†™ï¼Œå¦‚æœä½ éè¦ç”¨éæ ‡åä»£çš„è¯ï¼Œå¯ä»¥å¡«'ts.hpc.tw:443'è¿™æ ·

let å¯ç”¨SOCKS5åä»£ = true //å¦‚æœå¯ç”¨æ­¤åŠŸèƒ½ï¼ŒåŸå§‹åä»£å°†å¤±æ•ˆ
let å¯ç”¨SOCKS5å…¨å±€åä»£ = true //é€‰æ‹©æ˜¯å¦å¯ç”¨SOCKS5å…¨å±€åä»£ï¼Œå¯ç”¨åæ‰€æœ‰è®¿é—®éƒ½æ˜¯S5çš„è½åœ°ã€æ— è®ºä½ å®¢æˆ·ç«¯é€‰ä»€ä¹ˆèŠ‚ç‚¹ã€‘ï¼Œè®¿é—®è·¯å¾„æ˜¯å®¢æˆ·ç«¯--CF--SOCKS5ï¼Œå½“ç„¶å¯ç”¨æ­¤åŠŸèƒ½åå»¶è¿Ÿ=CF+SOCKS5ï¼Œå¸¦å®½å–å†³äºSOCKS5çš„å¸¦å®½ï¼Œä¸å†äº«å—CFé«˜é€Ÿå’Œéšæ—¶æ»¡å¸¦å®½çš„å¾…é‡
let æˆ‘çš„SOCKS5è´¦å· = '12349:12349@23.231.215.32:10000' //æ ¼å¼'è´¦å·:å¯†ç @åœ°å€:ç«¯å£'

let æˆ‘çš„èŠ‚ç‚¹åå­— = 'TS-git' //è‡ªå·±çš„èŠ‚ç‚¹åå­—ã€ç»Ÿä¸€åç§°ã€‘
//////////////////////////////////////////////////////////////////////////æµæ§é…ç½®////////////////////////////////////////////////////////////////////////
//æ§æµæœºåˆ¶é€šè¿‡ä¸»åŠ¨æ§åˆ¶ä¼ è¾“é€Ÿåº¦ï¼Œè¾¾åˆ°ç¨³å®šæ€§ç›®çš„ï¼Œå¼Šç«¯å°±æ˜¯é™åˆ¶å¸¦å®½ï¼Œå–œæ¬¢å¤§å¸¦å®½çš„å…³é—­å³å¯ï¼Œé«˜ç«¯ç©å®¶å¯è‡ªè¡Œåˆ°ç›¸å…³å‡½æ•°ç»†è°ƒå‚æ•°^_^
//é‡è¦ï¼ï¼ï¼æ§æµæ¨¡å¼ä»…ä½œè€…æœ¬äººæ ¹æ®è‡ªèº«ç½‘ç»œç¯å¢ƒè°ƒè¯•è€Œæ¥ï¼Œä¸ä¿è¯æ‰€æœ‰ç½‘ç»œæ•ˆæœï¼Œé«˜æ‰‹å¯è‡ªè¡Œåˆ°ç›¸å…³ä»£ç åŒºå—è°ƒå‚ï¼Œæ™®é€šç©å®¶è§‰å¾—ä¸å¥½ç”¨çš„è¯å…³æ‰æ§æµæœºåˆ¶å°±è¡Œï¼Œä¹Ÿå·²ç»å¾ˆå¥½ç”¨äº†^_^
//ç”±äºæˆ‘è®¾ç½®äº†è¯»å–è¶…æ—¶ä¸»åŠ¨æ–­å¼€é€»è¾‘ã€ä¸ºäº†ç»™å…¶ä»–è¯·æ±‚è®©å‡ºèµ„æºã€‘ï¼Œç‰¹åœ°å¼€å‘äº†ä¸€ä¸ªä¿æ´»åå•åŠŸèƒ½ï¼Œé’ˆå¯¹ä¸€äº›æœåŠ¡ç±»æˆ–èŠå¤©ç±»APPå¯è‡ªå®šä¹‰ä¿æ´»ç›®æ ‡ï¼Œåœ¨åº•éƒ¨æœ‰ä¸€ä¸ªå¯ä»¥è‡ªè¡Œç»´æŠ¤çš„ä¿æ´»åŸŸååå•
let å¯åŠ¨æ§æµæœºåˆ¶ = false; //é€‰æ‹©æ˜¯å¦å¯åŠ¨æ§æµæœºåˆ¶ï¼Œtrueå¯åŠ¨ï¼Œfalseå…³é—­ï¼Œä½¿ç”¨æ§æµå¯æå‡è¿æ¥ç¨³å®šæ€§ï¼Œé€‚åˆè½»åº¦ä½¿ç”¨ï¼Œæ—¥å¸¸ä½¿ç”¨åº”è¯¥ç»°ç»°æœ‰ä½™
//////////////////////////////////////////////////////////////////////////ç½‘é¡µå…¥å£////////////////////////////////////////////////////////////////////////
export default {
  async fetch(è®¿é—®è¯·æ±‚, env) {
    const è¯»å–æˆ‘çš„è¯·æ±‚æ ‡å¤´ = è®¿é—®è¯·æ±‚.headers.get('Upgrade');
    const url = new URL(è®¿é—®è¯·æ±‚.url);
    if (!è¯»å–æˆ‘çš„è¯·æ±‚æ ‡å¤´ || è¯»å–æˆ‘çš„è¯·æ±‚æ ‡å¤´ !== 'websocket') {
      if (æˆ‘çš„ä¼˜é€‰TXT) {
        const é“¾æ¥æ•°ç»„ = Array.isArray(æˆ‘çš„ä¼˜é€‰TXT) ? æˆ‘çš„ä¼˜é€‰TXT : [æˆ‘çš„ä¼˜é€‰TXT];
        const æ‰€æœ‰èŠ‚ç‚¹ = [];
        for (const é“¾æ¥ of é“¾æ¥æ•°ç»„) {
          try {
            const å“åº” = await fetch(é“¾æ¥);
            const æ–‡æœ¬ = await å“åº”.text();
            const èŠ‚ç‚¹ = æ–‡æœ¬.split('\n').map(line => line.trim()).filter(line => line);
            æ‰€æœ‰èŠ‚ç‚¹.push(...èŠ‚ç‚¹);
          } catch (e) {
            console.warn(`æ— æ³•è·å–æˆ–è§£æé“¾æ¥: ${é“¾æ¥}`, e);
          }
        }
        if (æ‰€æœ‰èŠ‚ç‚¹.length > 0) {
          æˆ‘çš„ä¼˜é€‰ = æ‰€æœ‰èŠ‚ç‚¹;
        }
      }
      switch (url.pathname) {
        case `/${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š}`: {
          const è®¢é˜…é¡µé¢ = ç»™æˆ‘è®¢é˜…é¡µé¢(å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š, è®¿é—®è¯·æ±‚.headers.get('Host'));
          return new Response(`${è®¢é˜…é¡µé¢}`, {
            status: 200,
            headers: { "Content-Type": "text/plain;charset=utf-8" }
          });
        }
        case `/${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š}/${è½¬ç }${è½¬ç 2}`: {
          if (éšè—è®¢é˜…) {
            return new Response (`${å˜²è®½è¯­}`, {
              status: 200,
              headers: { "Content-Type": "text/plain;charset=utf-8" }
            });
          } else {
            const é€šç”¨é…ç½®æ–‡ä»¶ = ç»™æˆ‘é€šç”¨é…ç½®æ–‡ä»¶(è®¿é—®è¯·æ±‚.headers.get('Host'));
            return new Response(`${é€šç”¨é…ç½®æ–‡ä»¶}`, {
              status: 200,
              headers: { "Content-Type": "text/plain;charset=utf-8" }
            });
          }
        }
        case `/${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š}/${å°çŒ«}${å’ª}`: {
          if (éšè—è®¢é˜…) {
            return new Response (`${å˜²è®½è¯­}`, {
              status: 200,
              headers: { "Content-Type": "text/plain;charset=utf-8" }
            });
          } else {
            const å°çŒ«å’ªé…ç½®æ–‡ä»¶ = ç»™æˆ‘å°çŒ«å’ªé…ç½®æ–‡ä»¶(è®¿é—®è¯·æ±‚.headers.get('Host'));
            return new Response(`${å°çŒ«å’ªé…ç½®æ–‡ä»¶}`, {
              status: 200,
              headers: { "Content-Type": "text/plain;charset=utf-8" }
            });
          }
        }
        default:
          return new Response('Hello World!', { status: 200 });
      }
    } else if (è¯»å–æˆ‘çš„è¯·æ±‚æ ‡å¤´ === 'websocket'){
      //è¿™æ˜¯è¯»å–ç¯å¢ƒå˜é‡çš„å‡½æ•°ï¼Œç”±äºæœ¬äººå¹¶ä¸ä½¿ç”¨ï¼Œä¹Ÿæ²¡å»æµ‹è¯•æ˜¯å¦æœ‰éšè—bugï¼Œæ‡‚çš„äººå¯è‡ªè¡Œå°è¯•
      const è¯»å–ç¯å¢ƒå˜é‡ = (name, fallback, env) => {
        const raw = import.meta?.env?.[name] ?? env?.[name];
        if (raw === undefined || raw === null || raw === '') return fallback;
        if (typeof raw === 'string') {
          const trimmed = raw.trim();
          if (trimmed === 'true') return true;
          if (trimmed === 'false') return false;
          if (trimmed.includes('\n')) {
            return trimmed.split('\n').map(item => item.trim()).filter(Boolean);
          }
          if (!isNaN(trimmed) && trimmed !== '') return Number(trimmed);
          return trimmed;
        }
        return raw;
      };
      åä»£IP = è¯»å–ç¯å¢ƒå˜é‡('PROXYIP', åä»£IP, env);
      æˆ‘çš„SOCKS5è´¦å· = è¯»å–ç¯å¢ƒå˜é‡('SOCKS5', æˆ‘çš„SOCKS5è´¦å·, env);
      å¯ç”¨SOCKS5åä»£ = è¯»å–ç¯å¢ƒå˜é‡('SOCKS5OPEN', å¯ç”¨SOCKS5åä»£, env);
      å¯ç”¨SOCKS5å…¨å±€åä»£ = è¯»å–ç¯å¢ƒå˜é‡('SOCKS5GLOBAL', å¯ç”¨SOCKS5å…¨å±€åä»£, env);
      if (ç§é’¥å¼€å…³) {
        const éªŒè¯æˆ‘çš„ç§é’¥ = è®¿é—®è¯·æ±‚.headers.get('my-key')
        if (éªŒè¯æˆ‘çš„ç§é’¥ === å’¦è¿™æ˜¯æˆ‘çš„ç§é’¥å“) {
          return await å‡çº§WSè¯·æ±‚(è®¿é—®è¯·æ±‚);
        }
      } else {
        return await å‡çº§WSè¯·æ±‚(è®¿é—®è¯·æ±‚);
      }
    }
  }
};
////////////////////////////////////////////////////////////////////////è„šæœ¬ä¸»è¦æ¶æ„//////////////////////////////////////////////////////////////////////
//ç¬¬ä¸€æ­¥ï¼Œè¯»å–å’Œæ„å»ºåŸºç¡€è®¿é—®ç»“æ„
async function å‡çº§WSè¯·æ±‚(è®¿é—®è¯·æ±‚) {
  const åˆ›å»ºWSæ¥å£ = new WebSocketPair();
  const [å®¢æˆ·ç«¯, WSæ¥å£] = Object.values(åˆ›å»ºWSæ¥å£);
  const è¯»å–æˆ‘çš„åŠ å¯†è®¿é—®å†…å®¹æ•°æ®å¤´ = è®¿é—®è¯·æ±‚.headers.get('sec-websocket-protocol'); //è¯»å–è®¿é—®æ ‡å¤´ä¸­çš„WSé€šä¿¡æ•°æ®
  const è§£å¯†æ•°æ® = ä½¿ç”¨64ä½åŠ è§£å¯†(è¯»å–æˆ‘çš„åŠ å¯†è®¿é—®å†…å®¹æ•°æ®å¤´); //è§£å¯†ç›®æ ‡è®¿é—®æ•°æ®ï¼Œä¼ é€’ç»™TCPæ¡æ‰‹è¿›ç¨‹
  è§£æVLæ ‡å¤´(è§£å¯†æ•°æ®, WSæ¥å£); //è§£æVLæ•°æ®å¹¶è¿›è¡ŒTCPæ¡æ‰‹
  return new Response(null, { status: 101, webSocket: å®¢æˆ·ç«¯ }); //ä¸€åˆ‡å‡†å¤‡å°±ç»ªåï¼Œå›å¤å®¢æˆ·ç«¯WSè¿æ¥å‡çº§æˆåŠŸ
}
function ä½¿ç”¨64ä½åŠ è§£å¯†(è¿˜åŸæ··æ·†å­—ç¬¦) {
  è¿˜åŸæ··æ·†å­—ç¬¦ = è¿˜åŸæ··æ·†å­—ç¬¦.replace(/-/g, '+').replace(/_/g, '/');
  const è§£å¯†æ•°æ® = atob(è¿˜åŸæ··æ·†å­—ç¬¦);
  const è§£å¯†_ä½ _ä¸ª_ä¸å’š_å’™_å’šå‘› = Uint8Array.from(è§£å¯†æ•°æ®, (c) => c.charCodeAt(0));
  return è§£å¯†_ä½ _ä¸ª_ä¸å’š_å’™_å’šå‘›.buffer;
}
//ç¬¬äºŒæ­¥ï¼Œè§£è¯»VLåè®®æ•°æ®ï¼Œåˆ›å»ºTCPæ¡æ‰‹
let è®¿é—®åœ°å€, è®¿é—®ç«¯å£;
async function è§£æVLæ ‡å¤´(VLæ•°æ®, WSæ¥å£, TCPæ¥å£) {
  if (!ç§é’¥å¼€å…³ && éªŒè¯VLçš„å¯†é’¥(new Uint8Array(VLæ•°æ®.slice(1, 17))) !== å“å‘€å‘€è¿™æ˜¯æˆ‘çš„VLå¯†é’¥) {
    return new Response('è¿æ¥éªŒè¯å¤±è´¥', { status: 400 });
  }
  const è·å–æ•°æ®å®šä½ = new Uint8Array(VLæ•°æ®)[17];
  const æå–ç«¯å£ç´¢å¼• = 18 + è·å–æ•°æ®å®šä½ + 1;
  const å»ºç«‹ç«¯å£ç¼“å­˜ = VLæ•°æ®.slice(æå–ç«¯å£ç´¢å¼•, æå–ç«¯å£ç´¢å¼• + 2);
  è®¿é—®ç«¯å£ = new DataView(å»ºç«‹ç«¯å£ç¼“å­˜).getUint16(0);
  const æå–åœ°å€ç´¢å¼• = æå–ç«¯å£ç´¢å¼• + 2;
  const å»ºç«‹åœ°å€ç¼“å­˜ = new Uint8Array(VLæ•°æ®.slice(æå–åœ°å€ç´¢å¼•, æå–åœ°å€ç´¢å¼• + 1));
  const è¯†åˆ«åœ°å€ç±»å‹ = å»ºç«‹åœ°å€ç¼“å­˜[0];
  let åœ°å€é•¿åº¦ = 0;
  let åœ°å€ä¿¡æ¯ç´¢å¼• = æå–åœ°å€ç´¢å¼• + 1;
  switch (è¯†åˆ«åœ°å€ç±»å‹) {
    case 1:
      åœ°å€é•¿åº¦ = 4;
      è®¿é—®åœ°å€ = new Uint8Array( VLæ•°æ®.slice(åœ°å€ä¿¡æ¯ç´¢å¼•, åœ°å€ä¿¡æ¯ç´¢å¼• + åœ°å€é•¿åº¦) ).join('.');
      break;
    case 2:
      åœ°å€é•¿åº¦ = new Uint8Array( VLæ•°æ®.slice(åœ°å€ä¿¡æ¯ç´¢å¼•, åœ°å€ä¿¡æ¯ç´¢å¼• + 1) )[0];
      åœ°å€ä¿¡æ¯ç´¢å¼• += 1;
      è®¿é—®åœ°å€ = new TextDecoder().decode( VLæ•°æ®.slice(åœ°å€ä¿¡æ¯ç´¢å¼•, åœ°å€ä¿¡æ¯ç´¢å¼• + åœ°å€é•¿åº¦) );
      break;
    case 3:
      åœ°å€é•¿åº¦ = 16;
      const dataView = new DataView( VLæ•°æ®.slice(åœ°å€ä¿¡æ¯ç´¢å¼•, åœ°å€ä¿¡æ¯ç´¢å¼• + åœ°å€é•¿åº¦) );
      const ipv6 = [];
      for (let i = 0; i < 8; i++) { ipv6.push(dataView.getUint16(i * 2).toString(16)); }
      è®¿é—®åœ°å€ = ipv6.join(':');
      break;
    default:
      return new Response('æ— æ•ˆçš„è®¿é—®åœ°å€', { status: 400 });
  }
  const å†™å…¥åˆå§‹æ•°æ® = VLæ•°æ®.slice(åœ°å€ä¿¡æ¯ç´¢å¼• + åœ°å€é•¿åº¦);
  if (å¯ç”¨åä»£åŠŸèƒ½ && å¯ç”¨SOCKS5åä»£ && å¯ç”¨SOCKS5å…¨å±€åä»£) {
    TCPæ¥å£ = await åˆ›å»ºSOCKS5æ¥å£(è¯†åˆ«åœ°å€ç±»å‹, è®¿é—®åœ°å€, è®¿é—®ç«¯å£);
  } else {
    try {
    TCPæ¥å£ = connect({ hostname: è®¿é—®åœ°å€, port: è®¿é—®ç«¯å£ });
    await TCPæ¥å£.opened;
    } catch {
      if (å¯ç”¨åä»£åŠŸèƒ½) {
        if (å¯ç”¨SOCKS5åä»£) {
          TCPæ¥å£ = await åˆ›å»ºSOCKS5æ¥å£(è¯†åˆ«åœ°å€ç±»å‹, è®¿é—®åœ°å€, è®¿é—®ç«¯å£);
        } else {
          let [åä»£IPåœ°å€, åä»£IPç«¯å£] = åä»£IP.split(':');
          TCPæ¥å£ = connect({ hostname: åä»£IPåœ°å€, port: åä»£IPç«¯å£ || è®¿é—®ç«¯å£ });
        }
      }
    }
  }
  try {
    await TCPæ¥å£.opened;
  } catch {
    return new Response('è¿æ¥æ¡æ‰‹å¤±è´¥', { status: 400 });
  }
  å»ºç«‹ä¼ è¾“ç®¡é“(WSæ¥å£, TCPæ¥å£, å†™å…¥åˆå§‹æ•°æ®); //å»ºç«‹WSæ¥å£ä¸TCPæ¥å£çš„ä¼ è¾“ç®¡é“
}
function éªŒè¯VLçš„å¯†é’¥(å­—èŠ‚æ•°ç»„, èµ·å§‹ä½ç½® = 0) {
  const åå…­è¿›åˆ¶è¡¨ = Array.from({ length: 256 }, (_, å€¼) =>
    (å€¼ + 256).toString(16).slice(1)
  );
  const åˆ†æ®µç»“æ„ = [4, 2, 2, 2, 6];
  let å½“å‰ç´¢å¼• = èµ·å§‹ä½ç½®;
  const æ ¼å¼åŒ–UUID = åˆ†æ®µç»“æ„
    .map(æ®µé•¿åº¦ =>
      Array.from({ length: æ®µé•¿åº¦ }, () => åå…­è¿›åˆ¶è¡¨[å­—èŠ‚æ•°ç»„[å½“å‰ç´¢å¼•++]]).join('')
    )
    .join('-')
    .toLowerCase();
  return æ ¼å¼åŒ–UUID;
}
//ç¬¬ä¸‰æ­¥ï¼Œåˆ›å»ºå®¢æˆ·ç«¯WS-CF-ç›®æ ‡çš„ä¼ è¾“é€šé“å¹¶ç›‘å¬çŠ¶æ€
async function å»ºç«‹ä¼ è¾“ç®¡é“(WSæ¥å£, TCPæ¥å£, å†™å…¥åˆå§‹æ•°æ®, å†™å…¥é˜Ÿåˆ— = Promise.resolve(), å›å†™é˜Ÿåˆ— = Promise.resolve()) {
  let è¿æ¥å¼€å§‹æ—¶é—´ = performance.now();
  let ç´¯è®¡æ¥æ”¶å­—èŠ‚æ•° = 0;
  let å¼‚å¸¸ç»“æŸ = false;
  let ç»“æŸåŸå› ;
  let å·²æ¸…ç†èµ„æº = false;
  const æ€»æ•°æ®é˜¶æ¢¯å»¶è¿Ÿ = [
    { size: 1 * 1024 *1024, delay: 320 },
    { size: 50 * 1024 *1024, delay: 340 },
    { size: 100 * 1024 *1024, delay: 360 },
    { size: 200 * 1024 *1024, delay: 400 },
  ];
  function è·å–å½“å‰æ€»å»¶è¿Ÿ() {
    return (æ€»æ•°æ®é˜¶æ¢¯å»¶è¿Ÿ.slice().reverse().find(({ size }) => ç´¯è®¡æ¥æ”¶å­—èŠ‚æ•° >= size) ?? { delay: 300 }).delay;
  }
  WSæ¥å£.accept();
  WSæ¥å£.send(new Uint8Array([0, 0]));
  const ä¼ è¾“æ•°æ® = TCPæ¥å£.writable.getWriter();
  const è¯»å–æ•°æ® = TCPæ¥å£.readable.getReader();
  if (å†™å…¥åˆå§‹æ•°æ®) å†™å…¥é˜Ÿåˆ— = å†™å…¥é˜Ÿåˆ—.then(() => ä¼ è¾“æ•°æ®.write(å†™å…¥åˆå§‹æ•°æ®)).catch(); //å‘TCPæ¥å£æ¨é€æ ‡å¤´ä¸­æå–çš„åˆå§‹è®¿é—®æ•°æ®
  WSæ¥å£.addEventListener('message', event => å†™å…¥é˜Ÿåˆ— = å†™å…¥é˜Ÿåˆ—.then(() => ä¼ è¾“æ•°æ®.write(event.data)).catch());
  å¯åŠ¨å›ä¼ ();
  async function å¯åŠ¨å›ä¼ () {
    let å­—èŠ‚è®¡æ•° = 0;
    try {
      while (!å·²æ¸…ç†èµ„æº) {
        const { done: æµç»“æŸ, value: è¿”å›æ•°æ® } = await å¸¦è¶…æ—¶è¯»å–(è¯»å–æ•°æ®);
        if (æµç»“æŸ) {
          await æ¸…ç†èµ„æº();
          break;
        }
        if (è¿”å›æ•°æ®.length > 0) {
          ç´¯è®¡æ¥æ”¶å­—èŠ‚æ•° += è¿”å›æ•°æ®.length;
          å›å†™é˜Ÿåˆ— = å›å†™é˜Ÿåˆ—.then(() => WSæ¥å£.send(è¿”å›æ•°æ®)).catch();
          if (å¯åŠ¨æ§æµæœºåˆ¶ && (ç´¯è®¡æ¥æ”¶å­—èŠ‚æ•° - å­—èŠ‚è®¡æ•°) > 4*1024*1024) {
              console.log(`ç¨ç­‰ä¸€ä¼šï¼Œå½“å‰æ¥æ”¶æ•°æ®: ${æ ¼å¼åŒ–å­—èŠ‚(ç´¯è®¡æ¥æ”¶å­—èŠ‚æ•°)}ï¼Œå½“å‰è¿è¡Œæ—¶é—´: ${æ ¼å¼åŒ–æ—¶é—´(performance.now() - è¿æ¥å¼€å§‹æ—¶é—´)}`);
              await new Promise(resolve => setTimeout(resolve, è·å–å½“å‰æ€»å»¶è¿Ÿ() + 500));
              å­—èŠ‚è®¡æ•° = ç´¯è®¡æ¥æ”¶å­—èŠ‚æ•°;
          }
        }
      }
    } catch (err) {
      å¼‚å¸¸ç»“æŸ = true;
      ç»“æŸåŸå›  = err?.stack || String(err);
      await æ¸…ç†èµ„æº();
    }
  }
  async function å¸¦è¶…æ—¶è¯»å–(è¯»å–æ•°æ®, è¶…æ—¶ = 5000) {
    return new Promise(async (resolve, reject) => {
      const è¶…æ—¶è®¾ç½® = setInterval(async () => {
        if (åŒ¹é…åœ°å€(è®¿é—®åœ°å€, ä¿æ´»åŸŸååå•)) {
          console.log(`åŒç«¯ä¿æ´»: ${è®¿é—®åœ°å€}ï¼Œå½“å‰ä¼ è¾“æ—¶é—´: ${æ ¼å¼åŒ–æ—¶é—´(performance.now() - è¿æ¥å¼€å§‹æ—¶é—´)}`);
          å†™å…¥é˜Ÿåˆ— = å†™å…¥é˜Ÿåˆ—.then(() => ä¼ è¾“æ•°æ®.write(new Uint8Array(0))).catch(); //å®é™…ä¸Šå¹¶æ²¡æœ‰å‘é€ä»»ä½•æ•°æ®ï¼Œå› ä¸ºä»»ä½•å®é™…å‘é€æ•°æ®çš„è¡Œä¸ºéƒ½ä¼šè¢«TCPç›®æ ‡è§†ä¸ºéæ³•å¼ºåˆ¶æ–­å¼€ï¼Œè¿™ä¸ªåŠŸèƒ½åªæ˜¯å‘Šè¯‰CFâ€œæˆ‘è¿˜åœ¨ä½¿ç”¨â€
          å›å†™é˜Ÿåˆ— = å›å†™é˜Ÿåˆ—.then(() => WSæ¥å£.send(new Uint8Array(0))).catch();
        } else if (å¯åŠ¨æ§æµæœºåˆ¶) {
          clearInterval(è¶…æ—¶è®¾ç½®);
          reject(new Error ('è¯»å–è¶…æ—¶'))
        }
      }, è¶…æ—¶);
      await è¯»å–æ•°æ®.read()
        .then(ç»“æœ => {
          clearInterval(è¶…æ—¶è®¾ç½®);
          resolve({ ...ç»“æœ});
        })
        .catch(e => {
          clearInterval(è¶…æ—¶è®¾ç½®);
          reject(e);
        });
    });
  }
  async function æ¸…ç†èµ„æº() {
    if (å·²æ¸…ç†èµ„æº) return;
    å·²æ¸…ç†èµ„æº = true;
    await new Promise(resolve => setTimeout(resolve, 1000));
    try {
      if (å¼‚å¸¸ç»“æŸ) {
        console.log(`${è®¿é—®åœ°å€}å› ã€${ç»“æŸåŸå› }ã€‘æ–­å¼€ï¼Œæ€»æ¥æ”¶æ•°æ®: ${æ ¼å¼åŒ–å­—èŠ‚(ç´¯è®¡æ¥æ”¶å­—èŠ‚æ•°)}ï¼Œæ€»ä¼ è¾“æ—¶é—´: ${æ ¼å¼åŒ–æ—¶é—´(performance.now() - è¿æ¥å¼€å§‹æ—¶é—´)}`);
      } else {
        console.log(`${è®¿é—®åœ°å€}ä¼ è¾“å®Œæ¯•ï¼Œæ€»æ¥æ”¶æ•°æ®: ${æ ¼å¼åŒ–å­—èŠ‚(ç´¯è®¡æ¥æ”¶å­—èŠ‚æ•°)}ï¼Œæ€»ä¼ è¾“æ—¶é—´: ${æ ¼å¼åŒ–æ—¶é—´(performance.now() - è¿æ¥å¼€å§‹æ—¶é—´)}`);
      }
      WSæ¥å£.close(1000);
      await TCPæ¥å£.close?.();
    } catch {};
  }
  function æ ¼å¼åŒ–å­—èŠ‚(æ•°æ®å­—èŠ‚, ä¿ç•™ä½æ•° = 2) {
    const å•ä½ = ['B', 'KB', 'MB', 'GB', 'TB'];
    let æŒ‡æ•° = 0;
    let æ•°å€¼ = æ•°æ®å­—èŠ‚;
    while (æ•°å€¼ >= 1024 && æŒ‡æ•° < å•ä½.length - 1) {
      æ•°å€¼ /= 1024;
      æŒ‡æ•°++;
    }
    return `${æ•°å€¼.toFixed(ä¿ç•™ä½æ•°)} ${å•ä½[æŒ‡æ•°]}`;
  }
  function æ ¼å¼åŒ–æ—¶é—´(æ¯«ç§’æ•°) {
    const æ€»æ¯«ç§’ = æ¯«ç§’æ•°;
    const å°æ—¶ = Math.floor(æ€»æ¯«ç§’ / (3600 * 1000));
    const åˆ†é’Ÿ = Math.floor((æ€»æ¯«ç§’ % (3600 * 1000)) / (60 * 1000));
    const ç§’ = Math.floor((æ€»æ¯«ç§’ % (60 * 1000)) / 1000);
    const æ¯«ç§’ = æ€»æ¯«ç§’ % 1000;
    return `${å°æ—¶.toString().padStart(2, '0')}:${åˆ†é’Ÿ.toString().padStart(2, '0')}:${ç§’.toString().padStart(2, '0')}.${æ¯«ç§’.toString().padStart(3, '0')}`;
  }
  function åŒ¹é…åœ°å€(åœ°å€, åŸŸååå•) {
    const æ˜¯IPv4 = /^(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)){3}$/.test(åœ°å€);
    const æ˜¯IPv6 = /^(([0-9a-fA-F]{1,4}:){7}([0-9a-fA-F]{1,4}|:)|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9])?[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9])?[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9])?[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9])?[0-9]))$/.test(åœ°å€);
    if (æ˜¯IPv4 || æ˜¯IPv6) return true;
    return åŸŸååå•.some(è§„åˆ™ => åŒ¹é…åŸŸå(åœ°å€, è§„åˆ™));
  }
  function åŒ¹é…åŸŸå(åœ°å€, é€šé…è§„åˆ™) {
    if (é€šé…è§„åˆ™.startsWith('*.')) {
      const æ ¹åŸŸ = é€šé…è§„åˆ™.slice(2);
      return (
        åœ°å€ === æ ¹åŸŸ || // åŒ¹é…ä¸»åŸŸ
        åœ°å€.endsWith('.' + æ ¹åŸŸ) // åŒ¹é…å­åŸŸ
      );
    }
    return åœ°å€ === é€šé…è§„åˆ™;
  }
}
//////////////////////////////////////////////////////////////////////////SOCKS5éƒ¨åˆ†//////////////////////////////////////////////////////////////////////
async function åˆ›å»ºSOCKS5æ¥å£(è¯†åˆ«åœ°å€ç±»å‹, è®¿é—®åœ°å€, è®¿é—®ç«¯å£, è½¬æ¢è®¿é—®åœ°å€) {
  const { è´¦å·, å¯†ç , åœ°å€, ç«¯å£ } = await è·å–SOCKS5è´¦å·(æˆ‘çš„SOCKS5è´¦å·);
  const SOCKS5æ¥å£ = connect({ hostname: åœ°å€, port: ç«¯å£ });
  try {
    await SOCKS5æ¥å£.opened;
  } catch {
    return new Response('SOCKS5æœªè¿é€š', { status: 400 });
  }
  const ä¼ è¾“æ•°æ® = SOCKS5æ¥å£.writable.getWriter();
  const è¯»å–æ•°æ® = SOCKS5æ¥å£.readable.getReader();
  const è½¬æ¢æ•°ç»„ = new TextEncoder(); //æŠŠæ–‡æœ¬å†…å®¹è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ï¼Œå¦‚è´¦å·ï¼Œå¯†ç ï¼ŒåŸŸåï¼Œæ–¹ä¾¿ä¸S5å»ºç«‹è¿æ¥
  const æ„å»ºS5è®¤è¯ = new Uint8Array([5, 2, 0, 2]); //æ„å»ºè®¤è¯ä¿¡æ¯,æ”¯æŒæ— è®¤è¯å’Œç”¨æˆ·å/å¯†ç è®¤è¯
  await ä¼ è¾“æ•°æ®.write(æ„å»ºS5è®¤è¯); //å‘é€è®¤è¯ä¿¡æ¯ï¼Œç¡®è®¤ç›®æ ‡æ˜¯å¦éœ€è¦ç”¨æˆ·åå¯†ç è®¤è¯
  const è¯»å–è®¤è¯è¦æ±‚ = (await è¯»å–æ•°æ®.read()).value;
  if (è¯»å–è®¤è¯è¦æ±‚[1] === 0x02) { //æ£€æŸ¥æ˜¯å¦éœ€è¦ç”¨æˆ·å/å¯†ç è®¤è¯
    if (!è´¦å· || !å¯†ç ) {
      return å…³é—­æ¥å£å¹¶é€€å‡º();
    }
    const æ„å»ºè´¦å·å¯†ç åŒ… = new Uint8Array([ 1, è´¦å·.length, ...è½¬æ¢æ•°ç»„.encode(è´¦å·), å¯†ç .length, ...è½¬æ¢æ•°ç»„.encode(å¯†ç ) ]); //æ„å»ºè´¦å·å¯†ç æ•°æ®åŒ…ï¼ŒæŠŠå­—ç¬¦è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
    await ä¼ è¾“æ•°æ®.write(æ„å»ºè´¦å·å¯†ç åŒ…); //å‘é€è´¦å·å¯†ç è®¤è¯ä¿¡æ¯
    const è¯»å–è´¦å·å¯†ç è®¤è¯ç»“æœ = (await è¯»å–æ•°æ®.read()).value;
    if (è¯»å–è´¦å·å¯†ç è®¤è¯ç»“æœ[0] !== 0x01 || è¯»å–è´¦å·å¯†ç è®¤è¯ç»“æœ[1] !== 0x00) { //æ£€æŸ¥è´¦å·å¯†ç è®¤è¯ç»“æœï¼Œè®¤è¯å¤±è´¥åˆ™é€€å‡º
      return å…³é—­æ¥å£å¹¶é€€å‡º();
    }
  }
  switch (è¯†åˆ«åœ°å€ç±»å‹) {
    case 1: // IPv4
      è½¬æ¢è®¿é—®åœ°å€ = new Uint8Array( [1, ...è®¿é—®åœ°å€.split('.').map(Number)] );
      break;
    case 2: // åŸŸå
      è½¬æ¢è®¿é—®åœ°å€ = new Uint8Array( [3, è®¿é—®åœ°å€.length, ...è½¬æ¢æ•°ç»„.encode(è®¿é—®åœ°å€)] );
      break;
    case 3: // IPv6
      è½¬æ¢è®¿é—®åœ°å€ = new Uint8Array( [4, ...è®¿é—®åœ°å€.split(':').flatMap(x => [parseInt(x.slice(0, 2), 16), parseInt(x.slice(2), 16)])] );
      break;
    default:
      return å…³é—­æ¥å£å¹¶é€€å‡º();
  }
  const æ„å»ºè½¬æ¢åçš„è®¿é—®åœ°å€ = new Uint8Array([ 5, 1, 0, ...è½¬æ¢è®¿é—®åœ°å€, è®¿é—®ç«¯å£ >> 8, è®¿é—®ç«¯å£ & 0xff ]); //æ„å»ºè½¬æ¢å¥½çš„åœ°å€æ¶ˆæ¯
  await ä¼ è¾“æ•°æ®.write(æ„å»ºè½¬æ¢åçš„è®¿é—®åœ°å€); //å‘é€è½¬æ¢åçš„åœ°å€
  const æ£€æŸ¥è¿”å›å“åº” = (await è¯»å–æ•°æ®.read()).value;
  if (æ£€æŸ¥è¿”å›å“åº”[0] !== 0x05 || æ£€æŸ¥è¿”å›å“åº”[1] !== 0x00) {
    return å…³é—­æ¥å£å¹¶é€€å‡º();
  }
  ä¼ è¾“æ•°æ®.releaseLock();
  è¯»å–æ•°æ®.releaseLock();
  return SOCKS5æ¥å£;
  function å…³é—­æ¥å£å¹¶é€€å‡º() {
    ä¼ è¾“æ•°æ®.releaseLock();
    è¯»å–æ•°æ®.releaseLock();
    SOCKS5æ¥å£.close();
    return new Response('SOCKS5æ¡æ‰‹å¤±è´¥', { status: 400 });
  }
}
async function è·å–SOCKS5è´¦å·(SOCKS5) {
  const [è´¦å·æ®µ, åœ°å€æ®µ] = SOCKS5.split("@");
  const [è´¦å·, å¯†ç ] = [è´¦å·æ®µ.slice(0, è´¦å·æ®µ.lastIndexOf(":")), è´¦å·æ®µ.slice(è´¦å·æ®µ.lastIndexOf(":") + 1)];
  const [åœ°å€, ç«¯å£] = [åœ°å€æ®µ.slice(0, åœ°å€æ®µ.lastIndexOf(":")), åœ°å€æ®µ.slice(åœ°å€æ®µ.lastIndexOf(":") + 1)];
  return { è´¦å·, å¯†ç , åœ°å€, ç«¯å£ };
}
//////////////////////////////////////////////////////////////////////////è®¢é˜…é¡µé¢////////////////////////////////////////////////////////////////////////
let è½¬ç  = 'vl', è½¬ç 2 = 'ess', ç¬¦å· = '://', å°çŒ« = 'cla', å’ª = 'sh', æˆ‘çš„ç§é’¥;
if (ç§é’¥å¼€å…³) {
  æˆ‘çš„ç§é’¥ = `my-key: ${å’¦è¿™æ˜¯æˆ‘çš„ç§é’¥å“}`
} else {
  æˆ‘çš„ç§é’¥ = ""
}
function ç»™æˆ‘è®¢é˜…é¡µé¢(å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š, hostName) {
return `
1ã€æœ¬workerçš„ç§é’¥åŠŸèƒ½åªæ”¯æŒ${å°çŒ«}${å’ª}ï¼Œä»…open${å°çŒ«}${å’ª}å’Œ${å°çŒ«}${å’ª} metaæµ‹è¯•è¿‡ï¼Œå…¶ä»–${å°çŒ«}${å’ª}ç±»è½¯ä»¶è‡ªè¡Œæµ‹è¯•
2ã€è‹¥ä½¿ç”¨é€šç”¨è®¢é˜…è¯·å…³é—­ç§é’¥åŠŸèƒ½
3ã€å…¶ä»–éœ€æ±‚è‡ªè¡Œç ”ç©¶
é€šç”¨çš„ï¼šhttps${ç¬¦å·}${hostName}/${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š}/${è½¬ç }${è½¬ç 2}
çŒ«å’ªçš„ï¼šhttps${ç¬¦å·}${hostName}/${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š}/${å°çŒ«}${å’ª}
`;
}
function ç»™æˆ‘é€šç”¨é…ç½®æ–‡ä»¶(hostName) {
æˆ‘çš„ä¼˜é€‰.push(`${hostName}:443#å¤‡ç”¨èŠ‚ç‚¹`)
if (ç§é’¥å¼€å…³) {
  return `è¯·å…ˆå…³é—­ç§é’¥åŠŸèƒ½`
}else {
  return æˆ‘çš„ä¼˜é€‰.map(è·å–ä¼˜é€‰ => {
    const [ä¸»å†…å®¹,tls] = è·å–ä¼˜é€‰.split("@");
    const [åœ°å€ç«¯å£, èŠ‚ç‚¹åå­— = æˆ‘çš„èŠ‚ç‚¹åå­—] = ä¸»å†…å®¹.split("#");
    const æ‹†åˆ†åœ°å€ç«¯å£ = åœ°å€ç«¯å£.split(":");
    const ç«¯å£ =æ‹†åˆ†åœ°å€ç«¯å£.length > 1 ? Number(æ‹†åˆ†åœ°å€ç«¯å£.pop()) : 443;
    const åœ°å€ = æ‹†åˆ†åœ°å€ç«¯å£.join(":");
    const TLSå¼€å…³ = tls === 'notls' ? 'security=none' : 'security=tls';
    return `${è½¬ç }${è½¬ç 2}${ç¬¦å·}${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„VLå¯†é’¥}@${åœ°å€}:${ç«¯å£}?encryption=none&${TLSå¼€å…³}&sni=${hostName}&type=ws&host=${hostName}&path=%2F%3Fed%3D2560#${èŠ‚ç‚¹åå­—}`;
  }).join("\n");
}
}
function ç»™æˆ‘å°çŒ«å’ªé…ç½®æ–‡ä»¶(hostName) {
æˆ‘çš„ä¼˜é€‰.push(`${hostName}:443#å¤‡ç”¨èŠ‚ç‚¹`)
const ç”ŸæˆèŠ‚ç‚¹ = (æˆ‘çš„ä¼˜é€‰) => {
  return æˆ‘çš„ä¼˜é€‰.map(è·å–ä¼˜é€‰ => {
    const [ä¸»å†…å®¹,tls] = è·å–ä¼˜é€‰.split("@");
    const [åœ°å€ç«¯å£, èŠ‚ç‚¹åå­— = æˆ‘çš„èŠ‚ç‚¹åå­—] = ä¸»å†…å®¹.split("#");
    const æ‹†åˆ†åœ°å€ç«¯å£ = åœ°å€ç«¯å£.split(":");
    const ç«¯å£ =æ‹†åˆ†åœ°å€ç«¯å£.length > 1 ? Number(æ‹†åˆ†åœ°å€ç«¯å£.pop()) : 443;
    const åœ°å€ = æ‹†åˆ†åœ°å€ç«¯å£.join(":").replace(/^\[(.+)\]$/, '$1');
    const TLSå¼€å…³ = tls === 'notls' ? 'false' : 'true';
  return {
    nodeConfig: `- name: ${èŠ‚ç‚¹åå­—}-${åœ°å€}-${ç«¯å£}
  type: ${è½¬ç }${è½¬ç 2}
  server: ${åœ°å€}
  port: ${ç«¯å£}
  uuid: ${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„VLå¯†é’¥}
  udp: false
  tls: ${TLSå¼€å…³}
  sni: ${hostName}
  network: ws
  ws-opts:
    path: "/?ed=2560"
    headers:
      Host: ${hostName}
      ${æˆ‘çš„ç§é’¥}`,
    proxyConfig: `    - ${èŠ‚ç‚¹åå­—}-${åœ°å€}-${ç«¯å£}`
    };
  });
};
const èŠ‚ç‚¹é…ç½® = ç”ŸæˆèŠ‚ç‚¹(æˆ‘çš„ä¼˜é€‰).map(node => node.nodeConfig).join("\n");
const ä»£ç†é…ç½® = ç”ŸæˆèŠ‚ç‚¹(æˆ‘çš„ä¼˜é€‰).map(node => node.proxyConfig).join("\n");
return `
dns:
  nameserver:
    - 180.76.76.76
    - 2400:da00::6666
  fallback:
    - 8.8.8.8
    - 2001:4860:4860::8888
proxies:
${èŠ‚ç‚¹é…ç½®}
proxy-groups:
- name: ğŸš€ èŠ‚ç‚¹é€‰æ‹©
  type: select
  proxies:
    - è‡ªåŠ¨é€‰æ‹©
${ä»£ç†é…ç½®}
- name: è‡ªåŠ¨é€‰æ‹©
  type: url-test
  url: http://www.gstatic.com/generate_204
  interval: 60 #æµ‹è¯•é—´éš”
  tolerance: 30
  proxies:
${ä»£ç†é…ç½®}
- name: æ¼ç½‘ä¹‹é±¼
  type: select
  proxies:
    - DIRECT
    - ğŸš€ èŠ‚ç‚¹é€‰æ‹©
rules: # æœ¬äººè‡ªç”¨è§„åˆ™ï¼Œä¸ä¸€å®šé€‚åˆæ‰€æœ‰äººæ‰€æœ‰å®¢æˆ·ç«¯ï¼Œå¦‚å®¢æˆ·ç«¯å› è§„åˆ™é—®é¢˜æ— æ³•è®¢é˜…å°±åˆ é™¤å¯¹åº”è§„åˆ™å§ï¼Œæ¯ä¸ªäººéƒ½æœ‰è‡ªå·±ä¹ æƒ¯çš„è§„åˆ™ï¼Œè‡ªè¡Œç ”ç©¶å“¦
# ç­–ç•¥è§„åˆ™ï¼Œå»ºè®®ä½¿ç”¨metaå†…æ ¸ï¼Œéƒ¨åˆ†è§„åˆ™éœ€æ‰“å¼€${å°çŒ«}${å’ª} mateçš„ä½¿ç”¨geoip datç‰ˆæ•°æ®åº“ï¼Œæ¯”å¦‚TGè§„åˆ™å°±éœ€è¦ï¼Œæˆ–è€…è‡ªå®šä¹‰geoipçš„è§„åˆ™è®¢é˜…
# è¿™æ˜¯geoipçš„è§„åˆ™è®¢é˜…é“¾æ¥ï¼Œhttps://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/Country.mmdb
# - GEOSITE,category-ads-all,REJECT #ç®€å•å¹¿å‘Šè¿‡æ»¤è§„åˆ™ï¼Œè¦å¢åŠ è§„åˆ™æ•°å¯ä½¿ç”¨category-ads-all
- GEOSITE,cn,DIRECT #å›½å†…åŸŸåç›´è¿è§„åˆ™
- GEOIP,CN,DIRECT,no-resolve #å›½å†…IPç›´è¿è§„åˆ™
- GEOSITE,cloudflare,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #CFåŸŸåè§„åˆ™
- GEOIP,CLOUDFLARE,ğŸš€ èŠ‚ç‚¹é€‰æ‹©,no-resolve #CFIPè§„åˆ™
- GEOSITE,gfw,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #GFWåŸŸåè§„åˆ™
- GEOSITE,google,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #GOOGLEåŸŸåè§„åˆ™
- GEOIP,GOOGLE,ğŸš€ èŠ‚ç‚¹é€‰æ‹©,no-resolve #GOOGLE IPè§„åˆ™
- GEOSITE,netflix,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #å¥ˆé£åŸŸåè§„åˆ™
- GEOIP,NETFLIX,ğŸš€ èŠ‚ç‚¹é€‰æ‹©,no-resolve #å¥ˆé£IPè§„åˆ™
- GEOSITE,telegram,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #TGåŸŸåè§„åˆ™
- GEOIP,TELEGRAM,ğŸš€ èŠ‚ç‚¹é€‰æ‹©,no-resolve #TG IPè§„åˆ™
- GEOSITE,openai,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #GPTè§„åˆ™
- MATCH,æ¼ç½‘ä¹‹é±¼
`
}
////////////////////////////////////////////////////////////////////////ä¿æ´»åŸŸååå•//////////////////////////////////////////////////////////////////////
const ä¿æ´»åŸŸååå• = [ // ç”±äºå¤§éƒ¨åˆ†èŠå¤©éƒ½æ˜¯é€šè¿‡IPè¿›è¡Œä¼ è¾“ï¼Œæ‰€ä»¥å·²ç»é€šé…äº†æ‰€æœ‰IPç±»å‹çš„ä¿æ´»é€»è¾‘ï¼Œä»¥ä¸‹æ˜¯é’ˆå¯¹åŸŸåçš„ä¿æ´»
  '*.chatgpt.com',
  '*.openai.com',
  '*.apis.google.com',
  '*.mtalk.google.com',
  '*.wns.windows.com',
  '*.alive.github.com',
  // '*.googlevideo.com', // YouTube è§†é¢‘å†…å®¹åˆ†å‘åŸŸåï¼Œå¤§æµé‡æœåŠ¡

  // Firebase / FCM
  '*.firebaseio.com',
  '*.googleapis.com',
  '*.fcm.googleapis.com',
  '*.firebaseinstallations.googleapis.com',
  '*.googleusercontent.com',

  // Telegram
  '*.t.me', 't.me',
  '*.telegram.org',
  '*.telegram.me',
  '*.telegra.ph',
  '*.cdn-telegram.org', // å«å›¾ç‰‡/è¯­éŸ³ç­‰ CDN èµ„æºï¼Œå¯èƒ½ä¸­ç­‰æµé‡

  // Twitch
  '*.twitch.tv',         // Twitch ä¸»ç«™ï¼Œå¤§æµé‡ç›´æ’­è§†é¢‘
  '*.ttvnw.net',         // Twitch è§†é¢‘/ç›´æ’­ CDNï¼Œæé«˜æµé‡
  '*.jtvnw.net',         // Twitch ç”¨æˆ·è§†é¢‘å°é¢ç­‰ï¼Œå¯èƒ½ä¸­ç­‰æµé‡
  '*.ext-twitch.tv',
  '*.api.twitch.tv',
  '*.twitchcdn.net',     // Twitch é™æ€èµ„æº CDNï¼Œå¤§æµé‡æœåŠ¡

  // Discord
  '*.discord.com',
  '*.discordapp.com',
  '*.discord.media', // åŒ…å«å›¾åƒ/éŸ³é¢‘ä¸Šä¼ ï¼Œå¯èƒ½ä¸­ç­‰æµé‡
  '*.discord.gg',

  // WhatsApp
  '*.whatsapp.net',
  '*.whatsapp.com',
  'web.whatsapp.com',

  // Signal
  '*.signal.org',
  '*.whispersystems.org',

  // Facebook Messenger
  '*.facebook.com',
  '*.messenger.com',
  // '*.fbcdn.net',         // Facebook é™æ€èµ„æº CDNï¼Œå«å›¾åƒ/è§†é¢‘ç­‰

  // Instagram (æ¶ˆæ¯å’Œç›´æ’­)
  '*.instagram.com',
  // '*.cdninstagram.com',  // Instagram å›¾ç‰‡/è§†é¢‘ CDNï¼Œå¤§æµé‡æœåŠ¡

  // Twitter / X (æ¶ˆæ¯ä¸Spaces)
  '*.twitter.com',
  // '*.twimg.com',         // Twitter å›¾ç‰‡/è§†é¢‘ CDNï¼Œå¤§æµé‡æœåŠ¡

  // Line
  '*.line.me',
  '*.line-scdn.net', // éƒ¨åˆ†èµ„æºä¸ºéŸ³é¢‘ã€å›¾åƒï¼Œå¯èƒ½ä¸­ç­‰æµé‡

  // WeChat å›½é™…ç‰ˆ (WeChat Work/æµ·å¤–å°ç¨‹åº)
  '*.wechat.com',
  '*.wechatapp.com',
  '*.wx.qq.com',

  // TikTok / Douyin (ç›´æ’­/çŸ­æ¶ˆæ¯)
  // '*.tiktok.com',        // ä¸»ç«™è§†é¢‘æ’­æ”¾/ç›´æ’­ï¼Œå¤§æµé‡æœåŠ¡
  // '*.muscdn.com',        // å­—èŠ‚ç³» CDNï¼Œå«è§†é¢‘é™æ€èµ„æºï¼Œå¤§æµé‡
  '*.byteoversea.com',

  // Zoom (å®æ—¶é€šè¯ã€ä¼šè®®)
  '*.zoom.us',
  '*.zoom.com',

  // Microsoft Teams / Outlook é€šçŸ¥
  '*.teams.microsoft.com',
  '*.skype.com',
  '*.outlook.com',
  '*.office.com',

  // Slack
  '*.slack.com',
  '*.slack-edge.com', // å«æ–‡ä»¶ä¸Šä¼  CDNï¼Œå¯èƒ½ä¸­ç­‰æµé‡

  // Apple Push / iMessage
  '*.push.apple.com',
  '*.icloud.com',
  '*.imessage.com',

  // Snapchat
  '*.snapchat.com',
  // '*.sc-cdn.net',        // Snapchat CDN å›¾ç‰‡/è§†é¢‘æµï¼Œå¤§æµé‡æœåŠ¡

  // Reddit Chat
  '*.reddit.com',
  // '*.redditmedia.com',   // Reddit å›¾åƒ/è§†é¢‘ CDNï¼Œå¤§æµé‡æœåŠ¡

  // Clubhouse
  '*.clubhouseapi.com',

  // Threads
  '*.threads.net',
];
